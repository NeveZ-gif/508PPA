---
title: "Assignment4"
author: "Neve/Viva/Yaohan"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: yes
    toc: yes
    theme: flatly
    toc_float: yes
    code_folding: hide
    number_sections: no
  pdf_document:
    toc: yes
---

<style>
.kable thead tr th, .table thead tr th {
  text-align: left !important;}
table.kable, table.table {
  width: 100% !important;}
  body {
  line-height: 1.6;
  font-size: 16px
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  dpi = 150)
options(scipen = 999)

if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(tidyverse, sf, units, nngeo, tmap, tinytex, kableExtra, janitor, classInt,
       patchwork, here, tidycensus, lwgeom, lsr, haven, descr, RColorBrewer, stargazer,
       car, FNN, GGally, MASS, ISLR2, spdep, caret, ckanr, grid, gridExtra, ggcorrplot,
       jtools, broom, tufte, rmarkdown, corrr, RSocrata, viridis, spatstat, raster, knitr,
       classInt, jsonlite, pROC, plotROC, lubridate)

library(conflicted)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::recode)

# Import dataset
dat <- read_csv(here::here('data/raw/NIJ_s_Recidivism_Challenge_Full_Dataset_20240418.csv'))
str(dat)
table(dat$Recidivism_Within_3years)

palette5 <- c("#981FAC","#CB0F8B","#FF006A","#FE4C35","#FE9900")
palette4 <- c("#981FAC","#FF006A","#FE4C35","#FE9900")
palette2 <- c("#981FAC","#FF006A")
```

# Discussion

- Sensitivity：high cost, ruin others life
- Specificity：let go of criminals

# Plot of Variables

**Dependent Variable:**  
- Recidivism_Within_3years

**Categorical Variables:**
- Gender  
- Race  
- Age_at_Release  
- Education_Level (Reclassified)  
- Dependents  
- Prior_Arrest_Episodes_Felony (Reclassified)  
- Condition_MH_SA  
- Condition_Cog_Ed  
- Condition_Other  
- Delinquency_Reports (Reclassified)  
- Program_Attendances (Reclassified)  
- Program_UnexcusedAbsences (Reclassified)  
- Employment_Exempt

```{r categorical_plot, message = FALSE, warning = FALSE}
# Recode dependent variable and reclassify categorical variables
dat <- dat %>%
  mutate(Recidivism_Within_3years = as.character(Recidivism_Within_3years)) %>%
  mutate(Recidivism_Within_3years = as.factor(recode(Recidivism_Within_3years,
    `FALSE` = "0",
    `TRUE` = "1"))) %>%
  mutate(Education_Level = factor(case_when(
    Education_Level %in% c('At least some college') ~ 'At least some college',
    Education_Level %in% c('Less than HS diploma', 'High School Diploma') ~ 'High School or Less'),
    levels = c('High School or Less', 'At least some college'))) %>%
  mutate(Prior_Arrest_Episodes_Felony = factor(case_when(
    Prior_Arrest_Episodes_Felony %in% c('0', '1', '2') ~ '0-2',
    Prior_Arrest_Episodes_Felony %in% c('3', '4', '5', '6', '7', '8', '9') ~ '3 to 9',
    Prior_Arrest_Episodes_Felony %in% c('10 or more') ~ '10 or more'),
    levels = c('0-2', '3 to 9', '10 or more'))) %>%
  mutate(Delinquency_Reports = factor(case_when(
    Delinquency_Reports %in% c('0') ~ '0',
    Delinquency_Reports %in% c('1', '2', '3', '4 or more') ~ '1 or more'))) %>%
  mutate(Program_Attendances = factor(case_when(
    Program_Attendances %in% c('0') ~ '0',
    Program_Attendances %in% c('1', '2', '3', '4', '5', '6', '7', '8', '9') ~ '1 to 9',
    Program_Attendances %in% c('10 or more') ~ '10 or more'))) %>%
  mutate(Program_UnexcusedAbsences = factor(case_when(
    Program_UnexcusedAbsences %in% c('0') ~ '0',
    Program_UnexcusedAbsences %in% c('1', '2', '3 or more') ~ '1 or more')))

# Plot categorical variables
## Percent
dat %>%
  select(Recidivism_Within_3years,
         Gender,
         Race,
         Age_at_Release,
         Education_Level,
         Dependents,
         Prior_Arrest_Episodes_Felony,
         Condition_MH_SA,
         Condition_Cog_Ed,
         Condition_Other,
         Delinquency_Reports,
         Program_Attendances,
         Program_UnexcusedAbsences,
         Employment_Exempt) %>%
  gather(Variable, value, -Recidivism_Within_3years) %>%
  count(Variable, value, Recidivism_Within_3years) %>%
  group_by(Variable, value) %>%
  mutate(percent = round(n/sum(n)*100, digits = 2)) %>%
  ungroup() %>%
    ggplot(., aes(value, percent, fill = Recidivism_Within_3years)) +   
        geom_bar(position = "dodge", stat="identity") +
        facet_wrap(~Variable, ncol = 4, scales="free") +
        scale_fill_manual(values = palette2) +
        labs(x="Recidivism", y="Percentage",
             title = "Feature associations with the likelihood of Recidivism Within Three Years",
             subtitle = "Categorical features") +
        theme_bw() +
  theme(plot.title = element_text(size = 12, face = "bold")) +
  theme(legend.title = element_text(size = 9),
        legend.text = element_text(size = 8)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))

## Count
dat %>%
  select(Recidivism_Within_3years,
         Gender,
         Race,
         Age_at_Release,
         Education_Level,
         Dependents,
         Prior_Arrest_Episodes_Felony,
         Condition_MH_SA,
         Condition_Cog_Ed,
         Condition_Other,
         Delinquency_Reports,
         Program_Attendances,
         Program_UnexcusedAbsences,
         Employment_Exempt) %>%
  gather(Variable, value, -Recidivism_Within_3years) %>%
  count(Variable, value, Recidivism_Within_3years) %>%
    ggplot(., aes(value, n, fill = Recidivism_Within_3years)) +   
        geom_bar(position = "dodge", stat="identity") +
        facet_wrap(~Variable, ncol = 4, scales="free") +
        scale_fill_manual(values = palette2) +
        labs(x="Recidivism", y="Value",
             title = "Feature associations with the likelihood of Recidivism Within Three Years",
             subtitle = "Categorical features") +
        theme_bw() +
  theme(plot.title = element_text(size = 12, face = "bold")) +
  theme(legend.title = element_text(size = 9),
        legend.text = element_text(size = 8)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**Continuous Variables:**
- Supervision_Risk_Score_First  
- Percent_Days_Employed  
- Prison_Years (Categorical -> Continuous)  
- Prior_Arrest_Episodes_Misd (Categorical -> Continuous)  
- Prior_Conviction_Episodes_Felony (Categorical -> Continuous)  
- Prior_Conviction_Episodes_Misd (Categorical -> Continuous)

```{r continuous_plot, message = FALSE, warning = FALSE}
# Transform categorical variables into continuous variables
dat <- dat %>%
  mutate(Percent_Days_Employed = round(Percent_Days_Employed * 100, digit = 2)) %>%
  mutate(Prison_Years = case_when(
    Prison_Years == "Less than 1 year" ~ "1",
    Prison_Years == "1-2 years" ~ "2",
    Prison_Years == "Greater than 2 to 3 years" ~ "3",
    Prison_Years == "More than 3 years" ~ "4")) %>%
  mutate(Prison_Years = as.numeric(Prison_Years)) %>%
  mutate(Prior_Arrest_Episodes_Misd = case_when(
    Prior_Arrest_Episodes_Misd == "6 or more" ~ "6",
    TRUE ~ Prior_Arrest_Episodes_Misd)) %>%
  mutate(Prior_Arrest_Episodes_Misd = as.numeric(Prior_Arrest_Episodes_Misd)) %>%
  mutate(Prior_Conviction_Episodes_Felony = case_when(
    Prior_Conviction_Episodes_Felony == "3 or more" ~ "3",
    TRUE ~ Prior_Conviction_Episodes_Felony)) %>%
  mutate(Prior_Conviction_Episodes_Felony = as.numeric(Prior_Conviction_Episodes_Felony)) %>%
  mutate(Prior_Conviction_Episodes_Misd = case_when(
    Prior_Conviction_Episodes_Misd == "4 or more" ~ "4",
    TRUE ~ Prior_Conviction_Episodes_Misd)) %>%
  mutate(Prior_Conviction_Episodes_Misd = as.numeric(Prior_Conviction_Episodes_Misd))

# Plot continuous variables
## Mean
dat %>%
  select(Supervision_Risk_Score_First,
         Percent_Days_Employed,
         Prison_Years,
         Prior_Arrest_Episodes_Misd,
         Prior_Conviction_Episodes_Felony,
         Prior_Conviction_Episodes_Misd,
         Recidivism_Within_3years) %>%
  filter_all(all_vars(!is.na(.))) %>%
  gather(Variable, value, -Recidivism_Within_3years) %>%
    ggplot(aes(Recidivism_Within_3years, value, fill=Recidivism_Within_3years)) + 
      geom_bar(position = "dodge", stat = "summary", fun = "mean") + 
      facet_wrap(~Variable, scales = "free") +
      scale_fill_manual(values = palette2) +
      labs(x="Recidivism", y="Value", 
           title = "Feature associations with the likelihood of Recidivism Within Three Years",
           subtitle = "Continuous features") +
       theme_bw() +
  theme(plot.title = element_text(size = 12, face = "bold")) +
  theme(legend.title = element_text(size = 9),
        legend.text = element_text(size = 8)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))

## Density
dat %>%
   select(Supervision_Risk_Score_First,
         Percent_Days_Employed,
         Prison_Years,
         Prior_Arrest_Episodes_Misd,
         Prior_Conviction_Episodes_Felony,
         Prior_Conviction_Episodes_Misd,
         Recidivism_Within_3years) %>%
    filter_all(all_vars(!is.na(.))) %>%
    gather(Variable, value, -Recidivism_Within_3years) %>%
    ggplot() + 
    geom_density(aes(value, color=Recidivism_Within_3years), fill = "transparent") + 
    facet_wrap(~Variable, scales = "free") +
    scale_fill_manual(values = palette2) +
    labs(title = "Feature distributions of Recidivism Within Three Years vs. NO Recidivism Within Three Years",
         subtitle = "Continuous features") +
  theme_bw() +
  theme(plot.title = element_text(size = 12, face = "bold")) +
  theme(legend.title = element_text(size = 9),
        legend.text = element_text(size = 8)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Model Develop

```{r model_build, message = FALSE, warning = FALSE}
# Initial variable selection
## Build dataset
dat <- dat %>%
  select(Gender, Race, Age_at_Release, Education_Level, Dependents, Prior_Arrest_Episodes_Felony,
         Condition_MH_SA, Condition_Cog_Ed, Condition_Other, Delinquency_Reports, Program_Attendances,
         Program_UnexcusedAbsences, Employment_Exempt, Supervision_Risk_Score_First, Percent_Days_Employed,
         Prison_Years, Prior_Arrest_Episodes_Misd, Prior_Conviction_Episodes_Felony, Prior_Conviction_Episodes_Misd,
         Recidivism_Within_3years) %>%
filter_all(all_vars(!is.na(.)))

## Split dataset
set.seed(1)
trainIndex <- createDataPartition(dat$Recidivism_Within_3years, p = .50,
                                  list = FALSE,
                                  times = 1)
dat.train <- dat[trainIndex,]
dat.test  <- dat[-trainIndex,]

## Remove insignificant variables based on sensitivity and specificity
mod1 <- glm(Recidivism_Within_3years ~ .,
                 data = dat.train,
                 na.action = na.exclude,
                 family = binomial("logit"))

testProbs <- data.frame(Outcome = as.factor(dat.test$Recidivism_Within_3years),
                        Probs = predict(mod1, dat.test, type= "response")) %>% ### Test probabilities
  mutate(predOutcome  = as.factor(ifelse(Probs > 0.5 , "1", "0"))) ### Set thresholds
100 * prop.table(table(Observed = testProbs$Outcome, Predicted = testProbs$predOutcome), margin = 1)

### Remove Race
mod2 <- glm(Recidivism_Within_3years ~ . -Race,
                 data = dat.train,
                 na.action = na.exclude,
                 family = binomial("logit"))

testProbs <- data.frame(Outcome = as.factor(dat.test$Recidivism_Within_3years),
                        Probs = predict(mod2, dat.test, type= "response")) %>% ### Test probabilities
  mutate(predOutcome  = as.factor(ifelse(Probs > 0.5 , "1", "0"))) ### Set thresholds
100 * prop.table(table(Observed = testProbs$Outcome, Predicted = testProbs$predOutcome), margin = 1)

### Remove Delinquency_Reports
mod3 <- glm(Recidivism_Within_3years ~ . -Race -Delinquency_Reports,
                 data = dat.train,
                 na.action = na.exclude,
                 family = binomial("logit"))

testProbs <- data.frame(Outcome = as.factor(dat.test$Recidivism_Within_3years),
                        Probs = predict(mod3, dat.test, type= "response")) %>% ### Test probabilities
  mutate(predOutcome  = as.factor(ifelse(Probs > 0.5 , "1", "0"))) ### Set thresholds
100 * prop.table(table(Observed = testProbs$Outcome, Predicted = testProbs$predOutcome), margin = 1)

### Remove Employment_Exempt
mod4 <- glm(Recidivism_Within_3years ~ . -Race -Delinquency_Reports -Employment_Exempt,
                 data = dat.train,
                 na.action = na.exclude,
                 family = binomial("logit"))

testProbs <- data.frame(Outcome = as.factor(dat.test$Recidivism_Within_3years),
                        Probs = predict(mod4, dat.test, type= "response")) %>% ### Test probabilities
  mutate(predOutcome  = as.factor(ifelse(Probs > 0.5 , "1", "0"))) ### Set thresholds
100 * prop.table(table(Observed = testProbs$Outcome, Predicted = testProbs$predOutcome), margin = 1)

### Remove Prior_Conviction_Episodes_Felony
mod5 <- glm(Recidivism_Within_3years ~ . -Race -Delinquency_Reports -Employment_Exempt
            -Prior_Conviction_Episodes_Felony,
                 data = dat.train,
                 na.action = na.exclude,
                 family = binomial("logit"))

testProbs <- data.frame(Outcome = as.factor(dat.test$Recidivism_Within_3years),
                        Probs = predict(mod5, dat.test, type= "response")) %>% ### Test probabilities
  mutate(predOutcome  = as.factor(ifelse(Probs > 0.5 , "1", "0"))) ### Set thresholds
100 * prop.table(table(Observed = testProbs$Outcome, Predicted = testProbs$predOutcome), margin = 1)

### Confusion matrix
caret::confusionMatrix(testProbs$predOutcome, testProbs$Outcome, 
                       positive = "1") 
```

# Result Interpretation
1. Model Result 

2. Most Risky Person

# ROC Curve

The ROC curve, gives us another visual "goodness of fit" metric. One that is a bit more tricky. You want to have a curve that is "above" the y=x line, which is where your prediction rates for positives and negatives are "no better than a coin flip". If it's too "square" - you are probably over fit. The Area-Under-The-Curve or "AUC" calculation below will help guide your understanding of the ROC curve

```{r auc, message = FALSE, warning = FALSE}
pROC::auc(testProbs$Outcome, testProbs$Probs)
```

```{r roc_curve, warning = FALSE, message = FALSE}
ggplot(testProbs, aes(d = as.numeric(Outcome), m = Probs)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#FE9900") +
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  labs(title = "ROC Curve - clickModel") +
    theme_bw() +
  theme(plot.title = element_text(size = 12, face = "bold")) +
  theme(legend.title = element_text(size = 9),
        legend.text = element_text(size = 8)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Confusion Matrix

Each threshold (e.g. a probability above which a prediction is a "click" and below which it's a "no click") has it's own rate of error. These errors can be classified in four ways for a binary model.

A "confusion matrix" for the threshold of 50% shows us the rate at which we got True Positives (aka Sensitivity), False Positives, True Negatives (aka Specificity) and False Negatives for that threshold.

```{r thresholds}
testProbs <- 
  testProbs %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs$Probs > 0.5 , 1, 0)))
```

```{r confusion_matrix}
caret::confusionMatrix(testProbs$predOutcome, testProbs$Outcome, 
                       positive = "1")
```

# Sensitivity and Specificity

# Prediction

## Error

## Summary by Race

## Equity Discussion

# Cost-Benifit Analysis

# Conclusion




