---
title: "Property Value Prediction Model for Seattle"
author: "Viva/Yaohan"
date: "`r Sys.Date()`"
output:
   html_document:
    keep_md: yes
    toc: yes
    theme: flatly
    toc_float: yes
    code_folding: hide
    number_sections: no
    fontsize:12pt
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE
  )
options(scipen = 999)

if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(tidyverse, sf, units, nngeo, tmap, tinytex, kableExtra, ggplot2, janitor, classInt,
       patchwork, here, tidycensus, lwgeom, lsr, haven, descr, RColorBrewer, stargazer, car,
       FNN)

library(conflicted)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
```

# Introduction

This report elaborate on the process of developing and refining a comprehensive predictive model that accurately forecasts housing prices for King County, Washington (Seattle).

???by integrating both structural and locational attributes. The model aims to discern how various housing characteristics, such as size, age, and amenities, along with locational factors, including proximity to services, neighborhood quality, and accessibility, collectively impact property values.

# Main Steps



# Data Selection

**1. Internal Characteristics**
- Year built
- Year renovated
- Bedroom
- Bathroom
- Living area
- Lot area
- Waterfront
- View
- Condition
- Grade


**2. Socio-economic Characteristics**
- Population density (continuous)
- White population share (continuous)
- Age structure (continuous + category)
- Education level (continuous + category)
- Median household income (continuous + dummy)
- Employment rate (continuous)
- Poverty rate (continuous + dummy)


**3. Amenities Services**
- Subway Station (distance + category)
- School District (category)
- Park (area + count)
- Medical Facilities (distance + category)
- Commercial center (distance + count)
- Crime rate (distance + )

reference: https://www.rentseattle.com/blog/how-local-amenities-help-seattle-investors-find-good-properties

**4. Spatial Structure**
- Large district
- Small district


# Data Wrangling

## Boundary and House Location

```{r Seattle_boundary}
# read Seattle boundary
seattle <- st_read(here::here("data/raw/Boundary/Seattle_City.geojson")) %>%
  st_union() %>%
  st_as_sf()

ggplot() + 
    geom_sf(data = seattle, color = "#d7191c", linewidth = 0.4) +  # add Seattle boundary
    labs(title = "Seattle, King County") +  # set plot title
    theme_void() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

```{r house_location}
# import house data
hh<- read_csv(here::here("data/raw/kc_house_data.csv"))

# quick check of house data
str(hh)
anyNA(hh$lat)
anyNA(hh$long)

# create house location
hh <- hh %>%
  st_as_sf(coords = c("long", "lat"), crs = 4326, agr = "constant") %>%  # convert to sf object with specified CRS
  st_transform(st_crs(seattle)) %>%  # transform coordinate reference system to "Washington State Plane North"
  distinct()  # keep only distinct geometries

house <- hh %>%
  st_intersection(seattle)

# plot Seattle house location
ggplot() + 
    geom_sf(data = seattle, color = "#b2182b", linewidth = 0.5) +  # add Seattle boundary
    geom_sf(data = house, color = "#2166ac", size = 0.5, pch = 16) +  # add house location
    labs(title = "Seattle House Location") +  # set plot title
    theme_void() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

## Internal Characteristics

```{r}


```

## Socio-economic Characteristics

```{r load_key, results='hide'}
census_api_key("3ec2bee8c227ff3f9df970d0ffbb11ee1384076e", install = TRUE, overwrite = TRUE)
```

```{r load_variables}
acs_variable_list.2015 <- load_variables(2015, # year
                                         "acs5", # five year ACS estimates
                                         cache = TRUE)
```

```{r acs_vars}
acs_vars <- c("B01003_001E", # total population
              "B01001A_001E", # white alone
              "", #
              "", # 
              "B19013_001E", # median household income
              "B23025_004E", # employed labor force
              "B23025_003E", # total labor force
              "B17020_002E") # income below poverty level
```

- Population density (continuous)
- White population share (continuous)
- Age structure (continuous + category)
- Education level (continuous + category)
- Median household income (continuous + dummy)
- Employment rate (continuous)
- Poverty rate (continuous + dummy)

```{r get_acs_2015}
acsTractsSeattle.2015 <- get_acs(geography = "tract",
                             year = 2015, 
                             variables = acs_vars,
                             geometry = TRUE,
                             state = "PA", 
                             county = "Philadelphia",
                             output = "wide") %>%
  select (GEOID, NAME, all_of(acs_vars)) %>% 
  rename (total_pop = B01003_001E,
          white_pop = B01001A_001E,
          
          median_hh_income = B19013_001E,
          total_labor = B23025_003E,
          employ_labor = B23025_004E,
          poverty = B17020_002E) %>%
  mutate( )
```

## Amenities Characteristics

### subway station

- variable  
1) distance to the nearest station
2) categories based on distance (0-0.5/0.5-1/1+ mile) (0.5mile = 2640ft)  

- reference: "houses within a quarter mile to a half mile of a Metro station sold for 7.5% more, and houses within a half mile to a mile sold for 3.9% more." https://www.freddiemac.com/research/insight/20191002-metro-station-impact#:~:text=Similarly%2C%20houses%20within%20a%20quarter,mile%20sold%20for%203.9%25%20more.

- source: https://gis-kingcounty.opendata.arcgis.com/datasets/7fb1b64925db450e8f024940f697823e_390/explore?location=47.584121%2C-122.115870%2C10.45

```{r subway}
#read station point data
sub <- st_read(here::here("data/raw/Amenities/Metro_Sub_Stations_in_King_County___sub_stations_point.geojson"))%>%
  st_transform(st_crs(house))

# the distance to the nearest station 
house <-  house %>%
      mutate(sub_dis = nn_function(st_coordinates(house),
                                      st_coordinates(sub), k = 1))

# categories based on distance
house <- house %>%
  mutate(sub_cat = case_when(
    sub_dis <= 2640 ~ "within0.5mile",
    sub_dis > 2640 & sub_dis <= 5280 ~ "0.5-1mile",
    sub_dis > 5280 ~ "1+mile"
  ))
```

### school district

- variable: the name of the school district

- reference: "the price differentials for similar homes — same square footage, number of bedrooms and baths — that are located near each other but served by different school districts can range from tens of thousands to hundreds of thousands of dollars." https://www.seattletimes.com/business/how-much-do-good-schools-boost-home-prices/  

- source: https://gis-kingcounty.opendata.arcgis.com/datasets/94eb521c71f2401586c6ce6a34d68166_406/explore?location=47.672575%2C-122.604064%2C18.86

```{r school}
sch <- st_read(here::here("data/raw/Amenities/Seattle_School_Board_Director_Districts___dirdst_area.geojson"))%>%
  st_transform(st_crs(house))

# add the school district variable
house <- house %>% 
  st_join(sch%>%select(DIRDST), join = st_within)%>%
  rename(sch = "DIRDST")
```

### parks

- variable: 
1) area of parks within 500 feet radius
2) count of parks within 500 feet radius

- reference: "Most community-sized parks (~40 acres) had a substantial impact on home prices up to a distance of 500 to 600 feet. While the influence of larger parks extended out to 2,000 feet, beyond 500 feet the influence was relatively small." https://www.naturequant.com/blog/Impact-of-Parks-on-Property-Value/  

- source: https://gis-kingcounty.opendata.arcgis.com/datasets/a0c94c33228146c5ad95a1dff3b6963d_228/explore?location=47.557674%2C-122.213839%2C11.45

```{r park}
park<-st_read(here::here("data/raw/Amenities/Parks_in_King_County___park_area.geojson"))%>%
  st_transform(st_crs(house))%>%
  st_intersection(seattle)%>%
  mutate(park_area = st_area(.))
  
# area and count of parks within 500 feet

house_parks <- st_join(st_buffer(house, dist = 500), park, join = st_intersects)%>%
  group_by(id) %>% 
  summarise(park_c = n_distinct(SITENAME, na.rm = TRUE),
            sum_park_area = sum(park_area, na.rm = TRUE))

house <- house %>% 
    left_join(house_parks%>%
                st_drop_geometry()%>%
                select(id,park_c, sum_park_area), by = "id")%>%
  rename(park_area = "sum_park_area")

```

### water body

### tree canopy

- variable:

- reference:

- source: https://data-seattlecitygis.opendata.arcgis.com/datasets/SeattleCityGIS::seattle-tree-canopy-2016-2021-50-acre-hexagons/explore?layer=1&location=47.580733%2C-122.309741%2C11.26

```{r tree_canopy}

```

### medical facilities

- variable: 
1) average distance to the nearest 1/2/3 medical facilities
2) categories based on distance (0-0.5/0.5-1/1+ mile)

- reference: "hospitals would only be highly evaluated in a ‘close-but-not-too-close’ geographic location" https://www.researchgate.net/publication/282942128_The_non-linearity_of_hospitals'_proximity_on_property_prices_experiences_from_Taipei_Taiwan

- source: https://gis-kingcounty.opendata.arcgis.com/datasets/1b7f0fb5179a400f91a35c0b6bfd77c9_733/explore

```{r medical}
med <- st_read(here::here("data/raw/Amenities/Medical_Facilities_including_Hospitals___medical_facilities_point.geojson"))%>%
  st_transform(st_crs(house))%>%
  st_intersection(seattle)

# calculate the distance to the nearest medical facilities 
house <-  house %>%
      mutate(med_dis1 = nn_function(st_coordinates(house),
                                      st_coordinates(med), k = 1),
             med_dis2 = nn_function(st_coordinates(house),
                                      st_coordinates(med), k = 2),
             med_dis3 = nn_function(st_coordinates(house),
                                      st_coordinates(med), k = 3))

# categories based on distance
house <- house %>%
  mutate(med_cat = case_when(
    med_dis1 <= 2640 ~ "within0.5mile",
    med_dis1 > 2640 & med_dis1 <= 5280 ~ "0.5-1mile",
    med_dis1 > 5280 ~ "1+mile"
  ))
```

### commercial

- variable:  
1) average distance to the nearest 1/2/3 shops
2) categories based on distance (0-0.5/0.5-1/1+ mile)

- reference: 
1) "an inverse relationship between the housing price and its distance from the shopping mall" https://www.diva-portal.org/smash/get/diva2:1450713/FULLTEXT01.pdf  
2) "Notwithstanding the negative externalities of shopping centres, residential
properties within 100-metre radius of shopping centres command a higher premium
than those farther away although the price-distance relationship is not monotonic
while the proximity factor varies from housing estate to housing estate." https://www.prres.org/uploads/746/1752/Addae-Dapaah_Shopping_Centres_Proximate_Residential_Properties.pdf

- source:https://gis-kingcounty.opendata.arcgis.com/datasets/4fdb4709874b46cf8dbb284182ca0094_383/explore?showTable=true  
Select type by "CODE": https://www.arcgis.com/sharing/rest/content/items/4fdb4709874b46cf8dbb284182ca0094/info/metadata/metadata.xml?format=default&output=html
- 690 Shopping Centers

```{r commercial}
mark<- st_read(here::here("data/raw/Amenities/King_County_Landmarks___landmark_point.geojson"))%>%
  st_transform(st_crs(house))%>%
  st_intersection(seattle)

#select shopping center
mark_shop <- mark%>%
  filter(CODE == 690)

# calculate the distance to the nearest 1/2/3 shopping center(s) 
house <-  house %>%
      mutate(shop_dis1 = nn_function(st_coordinates(house),
                                      st_coordinates(mark_shop), k = 1),
             shop_dis2 = nn_function(st_coordinates(house),
                                      st_coordinates(mark_shop), k = 2),
             shop_dis3 = nn_function(st_coordinates(house),
                                      st_coordinates(mark_shop), k = 3))

# categories based on distance
house <- house %>%
  mutate(shop_cat = case_when(
    shop_dis1 <= 2640 ~ "within0.5mile",
    shop_dis1 > 2640 & shop_dis1 <= 5280 ~ "0.5-1mile",
    shop_dis1 > 5280 ~ "1+mile"
  ))
```

### crime

- variable:
1) count of crimes within a 1/8 mi
2) average distance to the nearest 1/2/3/4/5 crimes (robbery and  assault only)

- reference:"only robbery and aggravated assault crimes (per acre) exert a meaningful influence upon neighborhood housing values." https://sciencedirect.com/science/article/pii/S0166046210000086#aep-abstract-id3
"The overall effect on house prices of crime (measured as crime rates) is relatively small, but if its impact is measured by distance to a crime hot spot, the effect is non-negligible." https://www.researchgate.net/publication/335773241_Do_crime_hot_spots_affect_housing_prices_Do_crime_hot_spots_affect_housing_prices

- source:https://data.seattle.gov/Public-Safety/SPD-Crime-Data-2008-Present/tazs-3rd5/about_data

```{r crime}
#***To avoid rerunning the huge dataset***
#crime <- read.csv(here::here("data/raw/Amenities/SPD_Crime_Data__2008-Present_20240328.csv"))

# get the target crime
# crime_clean <- crime %>%
#   mutate(year = str_sub(Report.Number, 1, 4)) %>%
#   filter(year %in% c("2013", "2014", "2015") )%>% #choose those before and in 2015
#   filter(!Offense %in% c(
#     "Bad Checks",
#     "Bribery",
#     "Embezzlement",
#     "Extortion/Blackmail",
#     "Credit Card/Automated Teller Machine Fraud",
#     "False Pretenses/Swindle/Confidence Game",
#     "Identity Theft",
#     "Impersonation",
#     "Welfare Fraud",
#     "Wire Fraud",
#     "Curfew/Loitering/Vagrancy Violations",
#     "Driving Under the Influence",
#     "Drug Equipment Violations",
#     "Drug/Narcotic Violations",
#     "Betting/Wagering",
#     "Gambling Equipment Violation",
#     "Operating/Promoting/Assisting Gambling",
#     "Liquor Law Violations",
#     "Pornography/Obscene Material",
#     "Assisting or Promoting Prostitution",
#     "Prostitution",
#     "Weapon Law Violations"
#   ))%>% #exclude those with little impact on housing price e.g.Financial Crimes, Public Order Offenses
#   filter(Longitude != 0 & Latitude != 0)# select the valid ones
# 
# write.csv(crime_clean , here::here("data/processed/crime_clean.csv"), row.names = FALSE)

# read the cleaned data set
crime <- read.csv(here::here("data/processed/crime_clean.csv")) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)%>%
  st_transform(st_crs(house))

# count of crime within 1/8 mi
house$crime_c =
    st_buffer(house, 660) %>%
    aggregate(mutate(crime, counter = 1),., sum) %>%
    pull(counter)

# calculate the distance to the nearest 1/2/3/4/5 shopping center(s)
house <-  house %>%
      mutate(crime_dis1 = nn_function(st_coordinates(house),
                                      st_coordinates(crime), k = 1),
             crime_dis2 = nn_function(st_coordinates(house),
                                      st_coordinates(crime), k = 2),
             crime_dis3 = nn_function(st_coordinates(house),
                                      st_coordinates(crime), k = 3),
             crime_dis4 = nn_function(st_coordinates(house),
                                      st_coordinates(crime), k = 4),
             crime_dis5 = nn_function(st_coordinates(house),
                                      st_coordinates(crime), k = 5))
```



## Spatial Structure

```{r}

```




# Modeling


# Conclusion



# Plot Reference

```{r}
# plot Seattle house location
ggplot() + 
    geom_sf(data = seattle, color = "grey90", linewidth = 0.5) +  # Add Seattle boundary
    geom_sf(data = house, color = "black", size = 0.1, pch = 16) +
  geom_sf(data = crime, color = "green4", size = 0.01, pch = 16)+
    #geom_sf(data = mark_commer, color = "blue", size = 0.3, pch = 16) + 
    #geom_sf(data = poi_commer, color = "red", size = 0.3, pch = 16) + 
    labs(title = "Seattle House Location") +  # Set plot title
    theme_void() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```


